name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run type check
        run: pnpm turbo build --filter=@pickle-play/ui && pnpm typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pickle_play_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pickle_play_test
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo build --filter=@pickle-play/ui

      - name: Run unit tests
        run: pnpm test

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Push database schema
        run: pnpm db:push

      - name: Run E2E tests
        run: pnpm test:e2e

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.PRODUCTION_API_URL }}
          NEXT_PUBLIC_ENVIRONMENT: production

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-production-build
          path: apps/web/.next
          retention-days: 7

      - name: Upload API build
        uses: actions/upload-artifact@v4
        with:
          name: api-production-build
          path: apps/api/dist
          retention-days: 7

  deploy-database-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always() && needs.build.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    environment:
      name: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [deploy-database-migrations]
    environment:
      name: production
      url: ${{ vars.PRODUCTION_API_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download API build
        uses: actions/download-artifact@v4
        with:
          name: api-production-build
          path: apps/api/dist

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Production
        run: |
          cd apps/api
          railway up --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for API health check
        run: |
          echo "Waiting for API to be healthy..."
          for i in {1..30}; do
            if curl -sf "${{ vars.PRODUCTION_API_URL }}/health" > /dev/null; then
              echo "API is healthy!"
              exit 0
            fi
            echo "Attempt $i: API not ready yet, waiting..."
            sleep 10
          done
          echo "API health check failed after 5 minutes"
          exit 1

  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: [deploy-api]
    environment:
      name: production
      url: ${{ vars.PRODUCTION_WEB_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-production-build
          path: apps/web/.next

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel Production
        id: deploy
        run: |
          vercel deploy \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ vars.VERCEL_ORG_ID }} \
            --yes \
            --prod \
            --prebuilt \
            ./apps/web
        env:
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_WEB_PROJECT_ID }}

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api]
    steps:
      - name: Test Web App
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.PRODUCTION_WEB_URL }}")
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Web app returned status $HTTP_STATUS"
            exit 1
          fi
          echo "Web app is responding correctly"

      - name: Test API Health
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.PRODUCTION_API_URL }}/health")
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "API health check returned status $HTTP_STATUS"
            exit 1
          fi
          echo "API is healthy"

      - name: Test API Response
        run: |
          RESPONSE=$(curl -s "${{ vars.PRODUCTION_API_URL }}/health")
          echo "API Response: $RESPONSE"

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: success()
    steps:
      - name: Send Discord notification
        if: ${{ vars.DISCORD_WEBHOOK_URL != '' }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "Production Deployment Successful",
                "description": "Pickle Play has been deployed to production!",
                "color": 5763719,
                "fields": [
                  {"name": "Web App", "value": "${{ vars.PRODUCTION_WEB_URL }}", "inline": true},
                  {"name": "API", "value": "${{ vars.PRODUCTION_API_URL }}", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": false}
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            "${{ vars.DISCORD_WEBHOOK_URL }}"

      - name: Send Slack notification
        if: ${{ vars.SLACK_WEBHOOK_URL != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "Production Deployment Successful", "emoji": true}
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Web App:*\n<${{ vars.PRODUCTION_WEB_URL }}|View>"},
                    {"type": "mrkdwn", "text": "*API:*\n<${{ vars.PRODUCTION_API_URL }}|View>"}
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {"type": "mrkdwn", "text": "Commit: `${{ github.sha }}`"}
                  ]
                }
              ]
            }' \
            "${{ vars.SLACK_WEBHOOK_URL }}"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [deploy-database-migrations, deploy-api, deploy-web, smoke-test]
    if: failure()
    steps:
      - name: Send Discord failure notification
        if: ${{ vars.DISCORD_WEBHOOK_URL != '' }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "Production Deployment Failed",
                "description": "The production deployment for Pickle Play has failed!",
                "color": 15548997,
                "fields": [
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                  {"name": "Workflow", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            "${{ vars.DISCORD_WEBHOOK_URL }}"

      - name: Send Slack failure notification
        if: ${{ vars.SLACK_WEBHOOK_URL != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "Production Deployment Failed", "emoji": true}
                },
                {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "The production deployment has failed. Please investigate immediately."}
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`"},
                    {"type": "mrkdwn", "text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"}
                  ]
                }
              ]
            }' \
            "${{ vars.SLACK_WEBHOOK_URL }}"

  create-sentry-release:
    name: Create Sentry Release
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: success() && vars.SENTRY_ORG != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ github.sha }}
